<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Small Plans</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #todo-input {
            width: 634px;
            height: 2.5em;
            font-size: inherit;
            border: 1px solid blue;
            padding: 0 3px 0 3px;
        }
        details {
            margin-bottom: 20px;
            width: 100%;
            font-family: sans-serif;
        }
        details pre {
            padding: 10px 20px 20px 20px;
            white-space: pre-wrap;
            white-space: -moz-pre-wrap;
        }
        summary {
            /*padding: 20px 20px 20px 38px;*/
            /*text-indent: -18px;*/
            padding: 20px;
            border: 1px solid #9fb6ce;
            outline: none;
            list-style: none;
        }
        summary::-webkit-details-marker {
            display: none;
        }
        summary:hover,
        summary:focus {
            border: 1px solid black;
        }
        details.undone summary {
            background-color: #f2f9fb;
        }
        details.done summary {
            background-color: white;
        }
        details[open] {
            background-color: #fafafa;
            border: 1px solid #9fb6ce;
        }
        details[open] summary {
            border-width: 0 0 1px 0;
            border-style: solid;
            border-color: #9fb6ce;
        }
        section {
            width: 640px;
        }
        .cell.buttons {
            padding-right: 0.5em;
            text-align: right;
        }
        .cell.buttons a {
            text-decoration: none;
            color: lightseagreen;
        }
        textarea {
            width: 100%;
        }
        .DateAndButtons {
            display: flex;
        }
        .cell {
            flex: 1;
        }
        .cell.date {
            padding-left: 0.5em;
            color: #ddd;
        }
        .cell.date a {
            color: #ddd;
            text-decoration: none;
        }
        .cell.date a:hover {
            color: lightseagreen;
        }
    </style>
    <script>
        // https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API/Using_the_Web_Storage_API
        function storageAvailable(type) {
            let storage;
            try {
                storage = window[type];
                let x = '__storage_test__';
                storage.setItem(x, x);
                storage.removeItem(x);
                return true;
            }
            catch(e) {
                return e instanceof DOMException && (
                        // everything except Firefox
                    e.code === 22 ||
                    // Firefox
                    e.code === 1014 ||
                    // test name field too, because code might not be present
                    // everything except Firefox
                    e.name === 'QuotaExceededError' ||
                    // Firefox
                    e.name === 'NS_ERROR_DOM_QUOTA_REACHED') &&
                    // acknowledge QuotaExceededError only if there's something already stored
                    (storage && storage.length !== 0);
            }
        }
        function newTodoItem(summary) {
            let now = Date.now();
            return {
                id: `todoitem-${now.toString(36)}`,
                summary: summary,
                details: '',
                createdAt: now,
                updatedAt: now,
                doneAt: null,
                deletedAt: null,
            }
        }
        function simpleDate(timestamp) {
            const date = new Date(timestamp);
            let year = '' + date.getFullYear(),
                month = '' + (date.getMonth() + 1),
                day = '' + date.getDate();
            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;
            return [year, month, day].join('-');
        }
        function clearAndFillLocalStorage(db) {
            localStorage.clear();
            localStorage.setItem('projectTitle', db.projectTitle);
            localStorage.setItem('projectDescription', db.projectDescription);
            for (let item of db.undoneItems) {
                localStorage.setItem(item.id, JSON.stringify(item));
            }
            for (let item of db.doneItems) {
                localStorage.setItem(item.id, JSON.stringify(item));
            }
        }
    </script>
</head>
<body>

<h1><span id="project-title">Small Plans</span><button id="proj-title-btn">edit</button></h1>
<h2 id="project-description"></h2>
<form id="project-title-form" autocomplete="off">
    <input type="file" id="import-file">
    <button id="import-btn">import</button>
</form>
<form><button id="export-btn">export</button> <span id="json-url"></span></form>

<dialog id="proj-title-dialog"
        style="width: 80%; height: 300px; position: absolute; top: 30px;">
    <form autocomplete="off">
        <p>
            <label class="projectLabel" for="project-title-input">Project Title:</label>
            <input type="text" id="project-title-input" class="field" />
        </p>
        <p>
            <label class="projectLabel" for="description-input">Description:</label>
            <textarea id="description-input" class="field"></textarea>
        </p>
        <p>
            <input type="submit" disabled hidden><!--防止 enter 键提交表单-->
            <input id="proj-title-ok" type="button" value="ok">
            <button id="proj-title-cancel">cancel</button>
        </p>
    </form>
</dialog>

<template id="todo-template">
    <div class="todo-top-div">
        <dialog style="width: 550px; height: 300px; position: absolute;">
            <form autocomplete="off">
                <p>
                    <label>Summary:<br/>
                        <input type="text" class="todo-summary-input" />
                    </label>
                </p>
                <p>
                    <label>Details:<br/>
                        <textarea class="todo-details-input"></textarea>
                    </label>
                </p>
                <p>
                    <input type="submit" disabled hidden><!--防止 enter 键提交表单-->
                    <button class="todo-edit-ok">ok</button>
                    <button class="todo-edit-cancel">cancel</button>
                </p>
            </form>
        </dialog>
        <details class="undone">
            <summary>
                <span class="todo-summary">NEED SUMMARY</span>
                <span class="more-btn" hidden
                      style="color: #9fb6ce;cursor: pointer;">(more)</span>
            </summary>
            <div class="DateAndButtons">
                <div class="cell date">
                    <span class="done-at" hidden></span>
                    <a href="#" class="undoneBtn" hidden>(undone)</a>
                    <a href="#" class="doneBtn">(done)</a>
                </div>
                <div class="cell buttons"><a href="#" class="editBtn">edit</a> . <a href="#">delete</a></div>
            </div>
            <pre class="todo-details"></pre>
        </details>
    </div>
</template>

<section id="all-undone-elem"></section>

<form id="add-todo-form" autocomplete="off"
      style="width: 640px; margin-top: 1em; margin-bottom: 3em;">
    <label for="todo-input" style="font-weight: bold;">Add Todo:</label><br/>
    <input type="text" id="todo-input" />
</form>

<section id="all-done-elem"></section>

<script>
    if (!storageAvailable('localStorage')) {
        window.alert("当前浏览器不支持 localStorage, 可能无法正常使用本网页, 请使用支持 localStorage 的浏览器.")
    }
    const projTitle = document.getElementById('project-title');
    const projTitleInput =  document.getElementById('project-title-input');
    const projDescription = document.getElementById('project-description');
    const projDescriptionInput = document.getElementById('description-input');
    let undoneItems = [];
    let doneItems = [];
    const allUndoneElem = document.querySelector('#all-undone-elem');
    const allDoneElem = document.querySelector('#all-done-elem');
    const todoTemplate = document.querySelector('#todo-template');

    function getDB() {
        return {
            projectTitle: localStorage.getItem('projectTitle'),
            projectDescription: localStorage.getItem('projectDescription'),
            undoneItems: undoneItems,
            doneItems: doneItems,
        }
    }
    document.querySelector('#import-btn').addEventListener('click', function(event) {
        event.preventDefault();
        const file = document.querySelector('#import-file').files[0];
        const reader = new FileReader();
        reader.onerror = function () {
            window.alert("导入文件失败!");
        }
        reader.onload = function () {
            // noinspection
            let db = JSON.parse(reader.result);
            clearAndFillLocalStorage(db);
            window.location.reload();
        }
        reader.readAsText(file);
    })
    function showJsonUrl() {
        let dbBlob = new Blob([JSON.stringify(getDB(), null, 2)], {type: 'application/json'});
        let jsonUrl = window.URL.createObjectURL(dbBlob);
        document.querySelector('#json-url').innerHTML
            = `<a href="${jsonUrl}" download="small-plans.json">右键点击这里, 另存为</a>`
    }
    document.querySelector('#export-btn').addEventListener('click', function (event) {
        event.preventDefault();
        showJsonUrl();
    })

    // 这个函数很大, 因为很多按钮也在里面.
    // 注意: 每当修改 todoitem 的内容时, 都要更新 localStorage.
    function insertTodoElem(todoitem) {
        let todoElem = todoTemplate.content.cloneNode(true);
        let todoTopDiv = todoElem.querySelector('.todo-top-div');
        let todoDetails = todoTopDiv.querySelector('details');
        let doneAt = todoTopDiv.querySelector('.done-at');
        let doneBtn = todoTopDiv.querySelector('.doneBtn');
        let undoneBtn = todoTopDiv.querySelector('.undoneBtn');
        doneBtn.addEventListener('click', function(event) {
            event.preventDefault();
            todoitem.doneAt = Date.now();
            localStorage.setItem(todoitem.id, JSON.stringify(todoitem));
            let i = undoneItems.findIndex(item => item.id === todoitem.id);
            undoneItems.splice(i, 1);
            doneItems.push(todoitem);
            todoDetails.setAttribute('class', 'done');
            doneAt.removeAttribute('hidden');
            doneAt.innerText = `done at: ${simpleDate(todoitem.doneAt)}`;
            undoneBtn.removeAttribute('hidden');
            doneBtn.setAttribute('hidden', '');
            let elem = document.querySelector(`#${todoitem.id}`);
            allDoneElem.insertBefore(elem, allDoneElem.firstElementChild);
        });
        undoneBtn.addEventListener('click', event => {
            event.preventDefault();
            todoitem.doneAt = null;
            localStorage.setItem(todoitem.id, JSON.stringify(todoitem));
            let i = doneItems.findIndex(item => item.id === todoitem.id);
            doneItems.splice(i, 1);
            undoneItems.push(todoitem);
            todoDetails.setAttribute('class', 'undone');
            doneAt.setAttribute('hidden', '');
            doneAt.innerText = '';
            undoneBtn.setAttribute('hidden', '');
            doneBtn.removeAttribute('hidden');
            let elem = document.querySelector(`#${todoitem.id}`);
            allUndoneElem.appendChild(elem);
        });
        todoTopDiv.setAttribute('id', todoitem.id);
        let moreBtn = todoTopDiv.querySelector('.more-btn');
        if (todoitem.details) {
            moreBtn.removeAttribute('hidden');
        }
        const todoSummary = todoTopDiv.querySelector('.todo-summary');
        todoSummary.innerText = todoitem.summary;
        let pre = todoTopDiv.querySelector('.todo-details');
        pre.innerText = todoitem.details;
        let summary = todoTopDiv.querySelector('summary');
        summary.addEventListener('click', function() {
            if (todoDetails.hasAttribute('open') && pre.innerText.trim()) {
                moreBtn.removeAttribute('hidden');
            } else {
                moreBtn.setAttribute('hidden', '');
            }
        });
        const todoEditDialog = todoTopDiv.querySelector('dialog');
        const todoSummaryInput = todoTopDiv.querySelector('.todo-summary-input');
        const todoDetailsInput = todoTopDiv.querySelector('.todo-details-input');
        const todoEditOk = todoTopDiv.querySelector('.todo-edit-ok');
        const todoEditCancel = todoTopDiv.querySelector('.todo-edit-cancel');
        todoTopDiv.querySelector('.editBtn').addEventListener('click', function (event) {
            event.preventDefault();
            todoSummaryInput.value = todoitem.summary;
            todoDetailsInput.value = todoitem.details;
            todoEditDialog.setAttribute('open', '');
            todoSummaryInput.focus();
        });
        todoEditCancel.addEventListener('click', function (event) {
            event.preventDefault();
            todoEditDialog.removeAttribute('open');
        });
        todoEditOk.addEventListener('click', function (event) {
            event.preventDefault();
            todoitem.summary = todoSummaryInput.value.trim();
            // pre 的内容不删除前后空格, 但当其内容只有空格时则清空.
            let preText = todoDetailsInput.value;
            if (preText.trim() === '') {
                preText = '';
            }
            todoitem.details = preText;
            todoitem.updatedAt = Date.now();
            todoSummary.innerText = todoitem.summary;
            pre.innerText = todoitem.details;
            localStorage.setItem(todoitem.id, JSON.stringify(todoitem));
            console.log(todoitem.id);
            todoEditDialog.removeAttribute('open');
        });
        if (todoitem.doneAt) {
            todoDetails.classList.remove('undone');
            todoDetails.classList.add('done');
            doneAt.removeAttribute('hidden');
            doneAt.innerText = `done at: ${simpleDate(todoitem.doneAt)}`;
            undoneBtn.removeAttribute('hidden');
            doneBtn.setAttribute('hidden', '');
            allDoneElem.insertBefore(todoElem, allDoneElem.firstElementChild);
        } else {
            allUndoneElem.appendChild(todoElem);
        }
    }

    // 以上是设置, 从这里开始使页面发生可见的变化.
    if (localStorage.getItem('projectTitle')) {
        projTitle.innerText = localStorage.getItem('projectTitle');
        if (projTitle.innerText === '') projTitle.innerText = 'Small Plans';
    }
    if (localStorage.getItem('projectDescription')) {
        projDescription.innerText = localStorage.getItem('projectDescription');
    }
    for (let i = 0; i < localStorage.length; i++) {
        let key = localStorage.key(i);
        if (key.startsWith('todoitem-')) {
            let item = JSON.parse(localStorage.getItem(key));
            if (item.doneAt) {
                doneItems.push(item);
            } else {
                undoneItems.push(item);
            }
        }
    }
    undoneItems.sort((a, b) => {
        return a.createdAt - b.createdAt;
    });
    doneItems.sort((a, b) => {
        return a.doneAt - b.doneAt;
    });
    for (const item of undoneItems) insertTodoElem(item);
    for (const item of doneItems) insertTodoElem(item);

    const todoInput = document.getElementById('todo-input');
    todoInput.focus();

    const projTitleDialog = document.getElementById('proj-title-dialog');
    const projTitleBtn = document.getElementById('proj-title-btn');
    const projTitleOk = document.getElementById('proj-title-ok');
    const projTitleCancel = document.getElementById('proj-title-cancel');
    projTitleBtn.addEventListener('click', function() {
        projTitleInput.value = localStorage.getItem('projectTitle');
        projDescriptionInput.value = localStorage.getItem('projectDescription');
        projTitleDialog.setAttribute('open', '');
        projTitleInput.focus();
    });
    projTitleCancel.addEventListener('click', function(event) {
        event.preventDefault();
        projTitleDialog.removeAttribute('open');
    });
    projTitleOk.addEventListener('click', function(event) {
        event.preventDefault();
        projTitle.innerText = projTitleInput.value.trim();
        localStorage.setItem('projectTitle', projTitle.innerText);
        projDescription.innerText = projDescriptionInput.value.trim();
        localStorage.setItem('projectDescription', projDescription.innerText);
        projTitleDialog.removeAttribute('open');
    });
    // projTitleInput.addEventListener('keyup', (event) => {
    //     if (event.key === 'Escape') {
    //         projTitleDialog.removeAttribute('open');
    //     }
    // });
    const addTodoForm = document.getElementById('add-todo-form');
    addTodoForm.addEventListener('submit', function(event) {
        event.preventDefault();
        let todo = todoInput.value.trim();
        if (todo) {
            let item = newTodoItem(todo);
            localStorage.setItem(item.id, JSON.stringify(item));
            undoneItems.push(item);
            insertTodoElem(item);
            todoInput.value = '';
            todoInput.focus();
        }
    });
</script>
</body>
</html>
